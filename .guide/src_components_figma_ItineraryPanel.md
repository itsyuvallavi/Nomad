
# File Explanation: `src/components/figma/ItineraryPanel.tsx`

## Summary

This is a major, high-level component that renders the entire right-hand side of the main application view. It takes the complete itinerary data object generated by the AI and transforms it into a rich, interactive user interface.

Its key responsibilities include:
- Displaying the overall trip title, dates, and other metadata.
- Fetching and displaying destination images from the Pexels API.
- Handling multi-destination trips by grouping days by location and providing tabs to switch between them.
- Rendering the list of `DayItinerary` components for the selected location.
- Displaying relevant `TripActions` (like quick tips) and `CoworkingSection` components.

---

## Detailed Breakdown

### Imports
- **Child Components**: `DayItinerary`, `CoworkingSection`, `TripActions`.
- **`framer-motion`**: For animating the main sections.
- **`react` hooks**: `useState` and `useEffect` for managing state and side effects (like fetching images).
- **`next/image`**: The optimized Image component from Next.js.
- **Pexels API**: The function `searchPexelsImages` to fetch real destination photos.

### State Management
```typescript
export function ItineraryPanel({ itinerary }: ItineraryPanelProps) {
  const [destinationImages, setDestinationImages] = useState<Record<string, PexelsImage[]>>({});
  // ... logic to group days ...
  const [selectedLocation, setSelectedLocation] = useState(locations[0] || '');
}
```
- **`destinationImages`**: An object that acts as a cache for images fetched from the Pexels API. The keys are destination names (e.g., "Zimbabwe"), and the values are arrays of image objects.
- **`selectedLocation`**: A string that holds the currently selected location tab (e.g., "Zimbabwe"). This state determines which group of daily itineraries to display. It defaults to the first location found.

### Side Effects (`useEffect` Hooks)

1.  **Image Fetching**:
    ```typescript
    useEffect(() => {
      // ... logic to fetch images for each destination ...
      fetchImages();
    }, [itinerary.destination]);
    ```
    - This effect runs whenever the `itinerary.destination` string changes. It splits the string of destinations, loops through them, and calls `searchPexelsImages` for each one, populating the `destinationImages` state with the results.

2.  **Debugging Logs**:
    - Several `useEffect` hooks are used to log the results of the destination parsing and grouping logic. This is extremely helpful for debugging how the component is interpreting the AI's output.

### Core Logic: Grouping Days by Location

This is the most complex logic in the component, designed to handle multi-destination itineraries correctly.

```typescript
// First pass: identify country for each day based on content
const dayCountries = itinerary.itinerary.map((day: any, index) => {
  if (day._destination) {
    // Most reliable: Use metadata from the chunked generator
    return destination;
  }
  // Fallback: analyze text content of the day's title and activities
  // ...
});

// Second pass: group consecutive days by country
const daysByLocation = itinerary.itinerary.reduce((acc, day, index) => {
  const country = dayCountries[index];
  if (!acc[country]) { acc[country] = { days: [] /*...*/ }; }
  acc[country].days.push(day);
  return acc;
}, { /*...*/ });
```
- **Two-Pass System**:
    1.  **First Pass**: It iterates through every single day of the itinerary and tries to figure out which country that day belongs to. Its most reliable method is checking for a `_destination` metadata field, which is added by the `openai-chunked.ts` generator. If that's not present, it falls back to searching the day's text for country names.
    2.  **Second Pass**: It uses the results from the first pass to group the days into a new object called `daysByLocation`. The keys of this object are the location names (e.g., "Zimbabwe"), and the values are objects containing an array of `days` belonging to that location.

### JSX Structure

- **Trip Overview**: The top section displays the main `itinerary.title`, the calculated `tripDuration`, and keyword tags.
- **Destination Images**:
    - It renders a 3-column grid of images.
    - It now uses the `destinationImages` state to pull real images from Pexels. If Pexels fails, it gracefully falls back to using `source.unsplash.com` with dynamically generated search terms.
    - The `next/image` component is used for performance optimization.
- **Trip Actions & Coworking**: Renders the `TripActions` and `CoworkingSection` components, passing down the necessary data.
- **Location Tabs (Conditional)**:
    - `locations.length > 1 && (...)`: This JSX is only rendered if the trip has more than one destination.
    - It maps over the `locations` array to create a scrollable row of tabs.
    - The `onClick` handler for each tab updates the `selectedLocation` state.
    - Styling is applied conditionally based on whether a tab `isSelected`.
- **Daily Itinerary List**:
    - `(daysByLocation[selectedLocation]?.days || itinerary.itinerary).map(...)`: This is a clever line. It tries to get the array of days for the `selectedLocation`. If that doesn't exist (e.g., for a single-destination trip), it gracefully falls back to using the entire `itinerary.itinerary` array.
